<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>{{ university_name|capitalize }} — WiFi</title>

  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <script>
    tailwind.config = {
      darkMode:'class',
      theme:{ extend:{
        keyframes:{
          'slide-in-left':{'0%':{transform:'translateX(-100%)',opacity:'0'},'100%':{transform:'translateX(0)',opacity:'1'}},
          'slide-out-left':{'0%':{transform:'translateX(0)',opacity:'1'},'100%':{transform:'translateX(-100%)',opacity:'0'}},
          'fade-in-up':{'0%':{opacity:'0',transform:'translateY(8px) scale(.98)'},'100%':{opacity:'1',transform:'translateY(0) scale(1)'}},
          'scale-in':{'0%':{opacity:'0',transform:'scale(.96)'},'100%':{opacity:'1',transform:'scale(1)'}},
          'slide-up':{'0%':{transform:'translateY(10px)',opacity:'0'},'100%':{transform:'translateY(0)',opacity:'1'}},
          'fade-out':{'0%':{opacity:'1'},'100%':{opacity:'0'}}
        },
        animation:{
          'slide-in-left':'slide-in-left .32s cubic-bezier(.22,1,.36,1) both',
          'slide-out-left':'slide-out-left .26s cubic-bezier(.4,0,.2,1) both',
          'fade-in-up':'fade-in-up .35s cubic-bezier(.22,1,.36,1) both',
          'scale-in':'scale-in .24s cubic-bezier(.22,1,.36,1) both',
          'slide-up':'slide-up .28s cubic-bezier(.22,1,.36,1) both',
          'fade-out':'fade-out .2s ease both'
        }
      }}
    };
  </script>

  <script>
    if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      document.documentElement.classList.add('dark');
    }
  </script>

  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --sidebar-w:16rem; --easing:cubic-bezier(.22,1,.36,1);
    }
    #sidebar{
      position:fixed; inset:0 auto 0 0; width:var(--sidebar-w);
      background-color:#fff; transform:translateX(-100%); opacity:0; pointer-events:none;
      transition: transform .36s var(--easing), opacity .28s ease;
    }
    #sidebar[data-open="true"]{ transform:translateX(0); opacity:1; pointer-events:auto; }
    .dark #sidebar{ background-color:#111827; }
    #content{ transition: margin-left .36s var(--easing); }
    @media (min-width: 768px){
      body[data-sidebar-open="true"]  #content{ margin-left: var(--sidebar-w); }
      body[data-sidebar-open="false"] #content{ margin-left: 0; }
    }
    #sidebarBackdrop{ transition: opacity .28s ease; background: rgba(0,0,0,.55); -webkit-backdrop-filter: blur(2px); backdrop-filter: blur(2px); }
    tbody tr{ transition: background .2s, box-shadow .2s; }
    tbody tr:hover{ background:#f1f5f9; box-shadow:0 2px 8px rgba(0,0,0,.04); }
    .dark tbody tr:hover{ background:#23293a; }
    @media (prefers-reduced-motion: reduce){ #sidebar, #content, #sidebarBackdrop, *{ transition:none!important; animation:none!important; } }
  </style>
</head>

<body class="bg-gray-100 dark:bg-gray-900 min-h-screen flex dark:text-white">
  <div class="hidden opacity-0 animate-slide-in-left animate-slide-out-left animate-fade-in-up animate-scale-in animate-slide-up"></div>

  <!-- Sidebar -->
  <aside id="sidebar" data-open="false" class="z-50 w-64 bg-white dark:bg-gray-900 shadow-lg flex flex-col" aria-hidden="true">
    <div class="flex items-center gap-2 px-6 py-6 border-b border-gray-200 dark:border-gray-800">
      <div class="w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center text-white font-bold text-lg">EA</div>
      <span class="font-bold text-xl text-indigo-700 dark:text-indigo-300">EduWiFi Admin</span>
    </div>

    <button id="sidebarClose" class="p-2 m-2 rounded hover:bg-gray-100 dark:hover:bg-gray-800 active:scale-95 transition-transform" aria-label="Yopish" title="Yopish">
      <i data-lucide="x" class="w-6 h-6"></i>
    </button>

    <nav class="flex-1 px-2 py-4 overflow-y-auto">
      <a href="/admin_panel_main" class="flex items-center gap-3 px-4 py-2 rounded-lg text-gray-700 dark:text-white hover:bg-indigo-100 dark:hover:bg-indigo-900 font-semibold mb-2 transition-colors">
        <i data-lucide="home" class="w-5 h-5"></i> Bosh sahifa
      </a>

      <div class="group">
        <button id="wifiMenuBtn" type="button" aria-controls="wifiMenu" aria-expanded="true"
                class="flex items-center justify-between w-full px-4 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 text-indigo-700 dark:text-indigo-300 font-semibold bg-indigo-100 dark:bg-indigo-900 focus:outline-none transition-colors">
          <span class="flex items-center gap-3"><i data-lucide="wifi" class="w-5 h-5"></i> WiFi lar</span>
          <i id="wifiMenuArrow" data-lucide="chevron-down" class="w-4 h-4 transform rotate-180 transition-transform"></i>
        </button>

        <div id="wifiMenu" class="ml-8 mt-1 space-y-1 block">
          <a href="/wifi" class="flex items-center gap-2 block px-2 py-1 rounded bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300 font-semibold">
            <i data-lucide="list" class="w-4 h-4"></i> OTM lar
          </a>
          <a href="/admin_panel_settings" class="flex items-center gap-2 block px-2 py-1 rounded hover:bg-indigo-50 dark:hover:bg-indigo-800 text-gray-700 dark:text-white transition-colors">
            <i data-lucide="settings" class="w-4 h-4"></i> Sozlamalar
          </a>
          <a href="/admin_panel_ad" class="flex items-center gap-2 block px-2 py-1 rounded hover:bg-indigo-50 dark:hover:bg-indigo-800 text-gray-700 dark:text-white transition-colors">
            <i data-lucide="megaphone" class="w-4 h-4"></i> Reklamalar
          </a>
          <a href="/admin_panel_transaction" class="flex items-center gap-2 block px-2 py-1 rounded hover:bg-indigo-50 dark:hover:bg-indigo-800 text-gray-700 dark:text-white transition-colors">
            <i data-lucide="receipt-text" class="w-4 h-4"></i> Tranzaksiyalar
          </a>
          <a href="/admin_panel_users" class="flex items-center gap-2 block px-2 py-1 rounded hover:bg-indigo-50 dark:hover:bg-indigo-800 text-gray-700 dark:text-white transition-colors">
            <i data-lucide="users" class="w-4 h-4"></i> Foydalanuvchilar
          </a>
          <a href="/admin_panel_tarif" class="flex items-center gap-2 block px-2 py-1 rounded hover:bg-indigo-50 dark:hover:bg-indigo-800 text-gray-700 dark:text-white transition-colors">
            <i data-lucide="layers" class="w-4 h-4"></i> Tarif rejalar
          </a>
        </div>
      </div>

      <a href="/teachers" class="flex items-center gap-3 px-4 py-2 rounded-lg text-gray-700 dark:text-white hover:bg-indigo-100 dark:hover:bg-indigo-900 font-semibold mb-2 transition-colors">
        <i data-lucide="graduation-cap" class="w-5 h-5"></i> O'qituvchilar
      </a>
    </nav>
  </aside>

  <div id="sidebarBackdrop" class="fixed inset-0 bg-black/40 opacity-0 pointer-events-none md:hidden z-40"></div>

  <!-- Main -->
  <div id="content" class="flex-1 flex flex-col min-h-screen">
    <header class="flex items-center justify-between bg-white dark:bg-gray-800 shadow px-8 py-4 transition-colors duration-300 animate-slide-up">
      <button id="sidebarToggle" class="p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 active:scale-95 transition"
              aria-label="Sidebarni ochish/yopish" aria-controls="sidebar" aria-expanded="true" title="Menyu">
        <span id="iconSidebarOpen" class="hidden"><i data-lucide="panel-left-open" class="w-6 h-6"></i></span>
        <span id="iconSidebarClose"><i data-lucide="panel-left-close" class="w-6 h-6"></i></span>
      </button>

      <h2 class="text-2xl font-bold text-gray-700 dark:text-white">{{ university_name|capitalize }} — Dashboard</h2>

      <div class="flex items-center gap-4">
        <button id="themeToggle" class="w-10 h-10 rounded-full flex items-center justify-center bg-gray-200 dark:bg-gray-700 focus:outline-none active:scale-95 transition" title="Tungi/Yorug' rejim">
          <span id="themeIconSun" class="hidden"><i data-lucide="sun" class="w-6 h-6 text-gray-600 dark:text-white"></i></span>
          <span id="themeIconMoon"><i data-lucide="moon" class="w-6 h-6 text-gray-600 dark:text-white"></i></span>
        </button>

        <div class="relative">
          <button id="sidebarProfileBtn" class="w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center focus:outline-none active:scale-95 transition" aria-haspopup="true" aria-expanded="false" title="Profil">
            <i data-lucide="user-round" class="w-6 h-6 text-gray-600 dark:text-white"></i>
          </button>
          <div id="profileMenu" class="absolute right-0 mt-2 w-40 bg-white dark:bg-gray-800 rounded shadow-lg py-2 hidden z-50 animate-scale-in origin-top-right">
            <button id="sidebarLogoutBtn" class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 text-red-600 transition-colors">Chiqish</button>
          </div>
        </div>
      </div>
    </header>

    <div id="pageRoot" data-university="{{ university_name }}">
      <main class="flex-1 p-6 overflow-y-auto">
        <!-- Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
          <div class="bg-white dark:bg-gray-900 rounded-xl shadow p-5 flex items-center gap-4 card-anim">
            <div class="bg-indigo-100 dark:bg-indigo-800 p-3 rounded-full">
              <i data-lucide="radio" class="w-7 h-7 text-indigo-600 dark:text-indigo-300"></i>
            </div>
            <div>
              <div class="text-gray-500 dark:text-white text-xs">Umumiy ulanishlar</div>
              <div class="text-2xl font-bold dark:text-white" id="totalConnections">0</div>
            </div>
          </div>

          <div class="bg-white dark:bg-gray-900 rounded-xl shadow p-5 flex items-center gap-4 card-anim">
            <div class="bg-amber-100 dark:bg-amber-800 p-3 rounded-full">
              <i data-lucide="calendar-clock" class="w-7 h-7 text-amber-600 dark:text-amber-300"></i>
            </div>
            <div>
              <div class="text-gray-500 dark:text-white text-xs">Kunlik daromad</div>
              <div class="text-2xl font-bold" id="dailyIncome">0 so'm</div>
            </div>
          </div>

          <div class="bg-white dark:bg-gray-900 rounded-xl shadow p-5 flex items-center gap-4 card-anim">
            <div class="bg-yellow-100 dark:bg-yellow-800 p-3 rounded-full">
              <i data-lucide="circle-dollar-sign" class="w-7 h-7 text-yellow-600 dark:text-yellow-300"></i>
            </div>
            <div>
              <div class="text-gray-500 dark:text-white text-xs">Oylik daromad</div>
              <div class="text-2xl font-bold" id="monthlyIncome">0 so'm</div>
            </div>
          </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <!-- Ulanishlar -->
          <div class="bg-white dark:bg-gray-900 rounded-xl shadow p-5 card-anim" style="height:270px;">
            <div class="flex items-center justify-between mb-2">
              <div class="font-semibold text-gray-700 dark:text-gray-100">Ulanishlar</div>
              <div class="flex gap-2">
                <button class="connViewBtn px-2 py-1 rounded text-xs font-semibold text-gray-600 dark:text-gray-200 hover:bg-indigo-50 dark:hover:bg-indigo-800" data-view="year">Yil</button>
                <button class="connViewBtn px-2 py-1 rounded text-xs font-semibold text-indigo-600 dark:text-indigo-300 bg-indigo-50 dark:bg-indigo-800" data-view="month">Oy</button>
                <button class="connViewBtn px-2 py-1 rounded text-xs font-semibold text-gray-600 dark:text-gray-200 hover:bg-indigo-50 dark:hover:bg-indigo-800" data-view="day">Kun</button>
              </div>
            </div>
            <canvas id="connectionsChart" height="80"></canvas>
          </div>

          <!-- WiFi lar bo‘yicha tushum (universitet kesimida, Yil/Oy/Kun) -->
          <div class="bg-white dark:bg-gray-900 rounded-xl shadow p-5 card-anim relative" style="height:270px;">
            <div class="flex items-center justify-between mb-2 relative z-20">
              <div class="font-semibold text-gray-700 dark:text-gray-100">{{ university_name|capitalize }} bo'yicha tushum</div>
              <div class="flex gap-2 wifiIncomeControls">
                <button type="button" class="wifiIncomeBtn px-2 py-1 rounded text-xs font-semibold text-gray-600 dark:text-gray-200 hover:bg-indigo-50 dark:hover:bg-indigo-800" data-view="year">Yil</button>
                <button type="button" class="wifiIncomeBtn px-2 py-1 rounded text-xs font-semibold text-indigo-600 dark:text-indigo-300 bg-indigo-50 dark:bg-indigo-800" data-view="month">Oy</button>
                <button type="button" class="wifiIncomeBtn px-2 py-1 rounded text-xs font-semibold text-gray-600 dark:text-gray-200 hover:bg-indigo-50 dark:hover:bg-indigo-800" data-view="day">Kun</button>
              </div>
            </div>
            <canvas id="wifiIncomeChart" height="80"></canvas>
            <div id="wifiNoData" class="absolute inset-0 hidden items-center justify-center text-gray-400 dark:text-gray-500 text-sm pointer-events-none z-10">Ma'lumot yo'q</div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Yangi foydalanuvchilar -->
          <div class="bg-white dark:bg-gray-900 rounded-xl shadow p-5 card-anim">
            <div class="flex items-center justify-between mb-2">
              <div class="font-semibold text-gray-700 dark:text-white">Yangi foydalanuvchilar</div>
              <a id="seeAllUsers" class="text-xs font-semibold text-indigo-600 dark:text-indigo-300 hover:underline cursor-pointer">Barchasini ko‘rish</a>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead>
                  <tr class="text-gray-500 dark:text-white text-xs text-left">
                    <th class="py-2 px-2">ID</th>
                    <th class="py-2 px-2">Sana</th>
                    <th class="py-2 px-2">Foydalanuvchi</th>
                    <th class="py-2 px-2">Holat</th>
                    <th class="py-2 px-2">Telefon raqam</th>
                  </tr>
                </thead>
                <tbody id="accountsTable"></tbody>
              </table>
            </div>
          </div>

          <!-- So‘nggi tranzaksiyalar -->
          <div class="bg-white dark:bg-gray-900 rounded-xl shadow p-5 card-anim">
            <div class="flex items-center justify-between mb-2">
              <div class="font-semibold text-gray-700 dark:text-white">So‘nggi tranzaksiyalar</div>
              <a id="seeAllTransactions" class="text-xs font-semibold text-indigo-600 dark:text-indigo-300 hover:underline cursor-pointer">Barchasini ko‘rish</a>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead>
                  <tr class="text-gray-500 dark:text-white text-xs text-left">
                    <th class="py-2 px-2">ID</th>
                    <th class="py-2 px-2">Sana</th>
                    <th class="py-2 px-2">Miqdor</th>
                    <th class="py-2 px-2">Holat</th>
                    <th class="py-2 px-2">Izoh</th>
                  </tr>
                </thead>
                <tbody id="transactionsTable"></tbody>
              </table>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script src="{{ url_for('static', filename='js/link_login.js') }}"></script>

  <!-- Theme & UI JS (sidebar va h.k.) — o'zgarmagan -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      if (window.lucide && lucide.createIcons) { lucide.createIcons(); }

      const themeToggle = document.getElementById('themeToggle');
      const sunWrap = document.getElementById('themeIconSun');
      const moonWrap = document.getElementById('themeIconMoon');
      function setTheme(mode){
        if(mode==='dark'){ document.documentElement.classList.add('dark'); localStorage.setItem('theme','dark'); sunWrap && sunWrap.classList.remove('hidden'); moonWrap && moonWrap.classList.add('hidden'); }
        else{ document.documentElement.classList.remove('dark'); localStorage.setItem('theme','light'); sunWrap && sunWrap.classList.add('hidden'); moonWrap && moonWrap.classList.remove('hidden'); }
      }
      let savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      setTheme(savedTheme);
      themeToggle && themeToggle.addEventListener('click', () => { setTheme(document.documentElement.classList.contains('dark') ? 'light' : 'dark'); });

      const profileBtn = document.getElementById('sidebarProfileBtn');
      const profileMenu = document.getElementById('profileMenu');
      if (profileBtn && profileMenu){
        profileBtn.onclick = () => {
          profileMenu.classList.toggle('hidden');
          const expanded = profileBtn.getAttribute('aria-expanded') === 'true';
          profileBtn.setAttribute('aria-expanded', expanded ? 'false' : 'true');
          if (!profileMenu.classList.contains('hidden')) profileMenu.classList.add('animate-scale-in');
        };
      }
      const logoutBtn = document.getElementById('sidebarLogoutBtn');
      if (logoutBtn){
        logoutBtn.onclick = () => { localStorage.removeItem('loggedInUser'); localStorage.removeItem('loginExpiration'); window.location.href = '/admin_panel_login'; };
      }

      const aside = document.getElementById('sidebar');
      const toggleBtn = document.getElementById('sidebarToggle');
      const closeBtn = document.getElementById('sidebarClose');
      const backdrop = document.getElementById('sidebarBackdrop');
      const iconOpen = document.getElementById('iconSidebarOpen');
      const iconClose= document.getElementById('iconSidebarClose');
      const mql = window.matchMedia('(min-width: 768px)');

      function isMdUp(){ return mql.matches; }
      function isOpen(){ return aside && aside.dataset.open === 'true'; }
      function updateUI(){
        const open = isOpen();
        iconOpen && iconOpen.classList.toggle('hidden', open);
        iconClose && iconClose.classList.toggle('hidden', !open);
        toggleBtn && toggleBtn.setAttribute('aria-expanded', String(open));
        document.body.dataset.sidebarOpen = open ? 'true' : 'false';
        if (backdrop){
          const show = open && !isMdUp();
          backdrop.classList.toggle('opacity-100', show);
          backdrop.classList.toggle('pointer-events-auto', show);
          backdrop.classList.toggle('opacity-0', !show);
          backdrop.classList.toggle('pointer-events-none', !show);
        }
        document.body.classList.toggle('overflow-hidden', open && !isMdUp());
      }
      function openSidebar(){ aside.dataset.open = 'true'; updateUI(); }
      function closeSidebar(){ aside.dataset.open = 'false'; updateUI(); }
      function toggleSidebar(){ isOpen() ? closeSidebar() : openSidebar(); }
      function applyInitial(){ aside.dataset.open = isMdUp() ? 'true' : 'false'; updateUI(); }
      applyInitial();
      toggleBtn  && toggleBtn.addEventListener('click', toggleSidebar);
      closeBtn   && closeBtn.addEventListener('click', closeSidebar);
      backdrop   && backdrop.addEventListener('click', closeSidebar);
      window.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeSidebar(); });
      mql.addEventListener('change', applyInitial);

      const cards = document.querySelectorAll('.card-anim');
      cards.forEach((el, i) => { el.style.animationDelay = (i * 70) + 'ms'; el.classList.add('animate-fade-in-up'); });
    });
  </script>
</body>
</html>
